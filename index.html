<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DIKA Marketplace - Kategori Produk</title>
  <style>
    :root{
      --bg:#f8fafc; --card:#fff; --accent:#2563eb; --green:#16a34a;
      --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body {
      font-family: Inter, system-ui, Arial;
      margin: 0;
      background-image: url(market.jpg);
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center center;
      background-attachment: fixed;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.7);
      z-index: -1;
    }
    header{
      background:#0f172a; color:#fff; padding:18px 12px; text-align:center;
      font-weight:700; letter-spacing:0.4px;
    }
    .wrap{max-width:1000px; margin:22px auto; padding:0 16px;}

    /* ====== FILTER DROPDOWN ====== */
    .filter-bar {
      display:flex;
      justify-content:flex-end;
      margin-bottom:14px;
    }
    select {
      padding:8px 12px;
      border-radius:8px;
      border:1px solid #cbd5e1;
      font-weight:600;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
    }
    @media (max-width:900px){ .grid{ grid-template-columns: repeat(2,1fr);} }
    @media (max-width:560px){ .grid{ grid-template-columns: 1fr;} }

    .card{
      background:var(--card); border-radius:12px; padding:12px; box-shadow:0 6px 14px rgba(2,6,23,0.04);
      display:flex; flex-direction:column; gap:8px; min-height:110px;
    }
    .title{ font-weight:700; font-size:15px }
    .price{ color:var(--accent); font-weight:600 }
    .stock{ color:var(--muted); font-size:13px }
    .controls{ margin-top:auto; display:flex; gap:8px; align-items:center; justify-content:flex-end }
    .controls .btn { padding:8px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:600 }
    .btn-order{ background:var(--green); color:#fff }
    .qty{ width:68px; padding:6px; border-radius:8px; border:1px solid #e5e7eb; text-align:center }

    .cart{
      margin-top:18px; background:var(--card); padding:14px; border-radius:12px; box-shadow:0 6px 14px rgba(2,6,23,0.04);
    }
    .cart h3{ margin:0 0 10px 0 }
    .cart-list{ max-height:220px; overflow:auto; padding-right:8px }
    .cart-item{ display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #eee; font-size:14px }
    .cart-foot{ display:flex; justify-content:space-between; align-items:center; margin-top:10px }
    .checkout-btn{ background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700 }
    .clear-cart{ background:#ef4444; color:#fff; border:none; padding:8px 10px; border-radius:8px; cursor:pointer }
    .hint{ font-size:13px; color:var(--muted) }

    .popup-overlay, .loading-overlay {
      position: fixed; top:0; left:0; right:0; bottom:0;
      display:none; align-items:center; justify-content:center; z-index:9999;
    }
    .popup-overlay{ background: rgba(0,0,0,0.4);}
    .popup-box {
      background:white; padding:20px 24px; border-radius:14px;
      box-shadow:0 8px 24px rgba(0,0,0,0.2); max-width:300px; text-align:center;
      animation: popIn 0.25s ease;
    }
    .popup-box h4 {margin:0 0 8px; font-size:16px; font-weight:700;}
    .popup-btn {
      background:var(--accent); color:#fff; border:none; padding:8px 12px;
      border-radius:8px; cursor:pointer; font-weight:600;
    }

    .loading-overlay{background: rgba(255,255,255,0.8); flex-direction:column;}
    .spinner {
      border:4px solid #cbd5e1; border-top:4px solid var(--accent);
      border-radius:50%; width:48px; height:48px; animation: spin 1s linear infinite;
    }
    .loading-text {margin-top:12px; font-weight:600; color:#334155;}
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes popIn { from { transform:scale(0.8); opacity:0; } to { transform:scale(1); opacity:1; } }
  </style>
</head>
<body>
  <header>DIKA Official Marketplace</header>

  <div class="wrap">

    <div class="filter-bar">
      <select id="categoryFilter" onchange="filterCategory()">
        <option value="all">Semua Kategori</option>
        <option value="makanan">Makanan</option>
        <option value="minuman">Minuman</option>
        <option value="alat_tulis">Alat Tulis</option>
        <option value="pakaian">Pakaian</option>
        <option value="obat">Obat-obatan</option>
      </select>
    </div>

    <div id="productGrid" class="grid"></div>

    <div class="cart">
      <h3>ðŸ›’ Keranjang</h3>
      <div id="cartList" class="cart-list"><div class="hint">Keranjang kosong.</div></div>
      <div class="cart-foot">
        <div id="cartTotal" class="hint">Total: Rp 0</div>
        <div>
          <button class="clear-cart" onclick="clearCart()">Kosongkan</button>
          <button class="checkout-btn" onclick="checkoutAll()">ðŸ’³ Checkout Semua</button>
        </div>
      </div>
    </div>
  </div>

  <!-- POPUP -->
  <div id="popup" class="popup-overlay">
    <div class="popup-box">
      <h4 id="popupTitle">Notifikasi</h4>
      <p id="popupMsg">Pesan notifikasi</p>
      <button class="popup-btn" onclick="closePopup()">OK</button>
    </div>
  </div>

  <!-- LOADING -->
  <div id="loading" class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">Tunggu mengirim data ke Pusat...</div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw83iZtNtr-Gv8slLFfahcgp6WT-_U8hBuYceLxUYvl7cfLa-P3LriodFfWczo6zrV3/exec";

    const products = [
      // === MAKANAN ===
      { name: "Roti Coklat", price: 5000, stock: 30, category: "makanan" },
      { name: "Keripik Singkong", price: 4000, stock: 40, category: "makanan" },
      { name: "Mie Instan", price: 3500, stock: 60, category: "makanan" },

      // === MINUMAN ===
      { name: "Air Mineral 600ml", price: 3000, stock: 80, category: "minuman" },
      { name: "Teh Botol Sosro", price: 5000, stock: 50, category: "minuman" },
      { name: "Kopi Good Day", price: 4000, stock: 70, category: "minuman" },

      // === ALAT TULIS ===
      { name: "Buku Tulis Sinar Dunia (38 Lbr)", price: 5000, stock: 50, category: "alat_tulis" },
      { name: "Pulpen Standard AE7", price: 4000, stock: 100, category: "alat_tulis" },
      { name: "Penghapus Joyko", price: 2000, stock: 80, category: "alat_tulis" },
      { name: "Penggaris 30cm", price: 3000, stock: 40, category: "alat_tulis" },

      // === PAKAIAN ===
      { name: "Kaos Seragam Putih", price: 45000, stock: 20, category: "pakaian" },
      { name: "Celana Panjang Sekolah", price: 60000, stock: 15, category: "pakaian" },

      // === OBAT-OBATAN ===
      { name: "Minyak Kayu Putih 60ml", price: 15000, stock: 25, category: "obat" },
      { name: "Paracetamol Strip", price: 7000, stock: 40, category: "obat" }
    ];

    let filteredProducts = [...products];
    let cart = [];

    function filterCategory(){
      const val = document.getElementById("categoryFilter").value;
      filteredProducts = val === "all" ? products : products.filter(p => p.category === val);
      renderProducts();
    }

    function renderProducts(){
      const grid = document.getElementById("productGrid");
      grid.innerHTML = "";
      filteredProducts.forEach((p, idx) => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div>
            <div class="title">${p.name}</div>
            <div class="price">Rp ${p.price.toLocaleString()}</div>
            <div class="stock">Stok: ${p.stock}</div>
          </div>
          <div class="controls">
            <input type="number" id="qty-${idx}" class="qty" min="1" value="1" />
            <button class="btn-order btn" onclick="orderProduct(${idx})">Tambah</button>
          </div>`;
        grid.appendChild(card);
      });
    }

    function orderProduct(idx){
      const qty = parseInt(document.getElementById(`qty-${idx}`).value);
      const product = filteredProducts[idx];
      if(!product || qty < 1) return;
      if(product.stock < qty) return showPopup("Gagal", "Stok tidak cukup!");

      product.stock -= qty;
      const exist = cart.find(i => i.name === product.name);
      if(exist){
        exist.quantity += qty;
        exist.subtotal = exist.price * exist.quantity;
      } else {
        cart.push({...product, quantity: qty, subtotal: product.price * qty});
      }
      renderCart();
      renderProducts();
    }

    function renderCart(){
      const list = document.getElementById("cartList");
      const totalEl = document.getElementById("cartTotal");
      if(cart.length === 0){
        list.innerHTML = '<div class="hint">Keranjang kosong.</div>';
        totalEl.textContent = "Total: Rp 0";
        return;
      }
      list.innerHTML = "";
      cart.forEach((it, idx) => {
        list.innerHTML += `<div class="cart-item"><div>${it.name} (${it.quantity}x)</div>
          <div>Rp ${it.subtotal.toLocaleString()}
          <button style="margin-left:6px;padding:4px 6px;border:none;background:#ef4444;color:#fff;border-radius:6px" onclick="removeCart(${idx})">hapus</button></div></div>`;
      });
      const total = cart.reduce((a,b)=>a+b.subtotal,0);
      totalEl.textContent = "Total: Rp " + total.toLocaleString();
    }

    function removeCart(i){
      const it = cart[i];
      const prod = products.find(p => p.name === it.name);
      if(prod) prod.stock += it.quantity;
      cart.splice(i,1);
      renderCart(); renderProducts();
    }

    function clearCart(){
      cart.forEach(it => {
        const prod = products.find(p => p.name === it.name);
        if(prod) prod.stock += it.quantity;
      });
      cart=[]; renderCart(); renderProducts();
    }

    function showPopup(t,m){
      document.getElementById("popupTitle").textContent = t;
      document.getElementById("popupMsg").textContent = m;
      document.getElementById("popup").style.display="flex";
    }
    function closePopup(){document.getElementById("popup").style.display="none";}

    async function checkoutAll(){
      if(cart.length===0)return showPopup("Gagal","Keranjang kosong!");
      document.getElementById("loading").style.display="flex";
      const total = cart.reduce((s,i)=>s+i.subtotal,0);
      const payload = {
        transactionId:"ORDER-"+Math.floor(Math.random()*1e6),
        timestamp:new Date().toISOString(),
        total:total,
        items:cart
      };
      try{
        await fetch(SCRIPT_URL,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
        document.getElementById("loading").style.display="none";
        showPopup("Sukses","Checkout berhasil dikirim!");
        cart=[]; renderCart();
      }catch(e){
        document.getElementById("loading").style.display="none";
        showPopup("Error","Gagal kirim data!");
      }
    }

    renderProducts();
  </script>
</body>
</html>
